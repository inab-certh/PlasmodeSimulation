<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Running a single simulation • PlasmodeSimulation</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Running a single simulation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">PlasmodeSimulation</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/RunSimulation.html">Running a single simulation</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Running a single simulation</h1>
            
      

      <div class="d-none name"><code>RunSimulation.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">PlasmodeSimulation</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: data.table</span></span></code></pre></div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>For this demo we will use data from a synthetic database mapped to
OMOP-CDM. We can download the database from this <a href="https://drive.google.com/file/d/1l5wq57fAslnoFR2umFQvVZbDiq5IK0UF/view?usp=sharing" class="external-link">link</a>.The
database is a 1-million person sample of SynPUF (Synthetic Public Use
Files), converted to the OMOP Common Data Model. It is provided in
DuckDB format, so it can run locally on your machine using the R
<code>duckdb</code> package.</p>
<div class="section level3">
<h3 id="exposure-cohorts">Exposure cohorts<a class="anchor" aria-label="anchor" href="#exposure-cohorts"></a>
</h3>
<p>As a first step we will need to extract some cohorts of interest. For
this example, we will use 4 exposure cohorts, namely, lisinopril,
hydrochlorothiazide, amlodipine, and simvastatin. To extract these
cohorts from the database we will need to execute the following code.
Note that packages <a href="https://cran.r-project.org/web/packages/DBI/index.html" class="external-link">DBI</a>
and <a href="https://cran.r-project.org/web/packages/CohortConstructor/index.html" class="external-link">CohortConstructor</a>
and <a href="https://cran.r-project.org/web/packages/glue/index.html" class="external-link">glue</a>
will need to be installed first.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">connection</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span></span>
<span>  <span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://r.duckdb.org/reference/duckdb.html" class="external-link">duckdb</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  dbdir <span class="op">=</span> <span class="st">"database-1M_filtered.duckdb"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu">CDMConnector</span><span class="fu">::</span><span class="fu">cdmFromCon</span><span class="op">(</span></span>
<span>  con <span class="op">=</span> <span class="va">connection</span>,</span>
<span>  cdmSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  writeSchema <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>prefix <span class="op">=</span> <span class="st">"demo_"</span>, schema <span class="op">=</span> <span class="st">"main"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">conceptListExposures</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  lisinopril <span class="op">=</span> <span class="fl">19080128</span>,</span>
<span>  hydrochlorothiazide <span class="op">=</span> <span class="fl">19078106</span>,</span>
<span>  amlodipine <span class="op">=</span> <span class="fl">19073094</span>,</span>
<span>  simvastatin <span class="op">=</span> <span class="fl">1539463</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">cdm</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">CohortConstructor</span><span class="fu">::</span><span class="fu">conceptCohort</span><span class="op">(</span></span>
<span>    conceptSet <span class="op">=</span> <span class="va">conceptListExposures</span>,</span>
<span>    exit <span class="op">=</span> <span class="st">"event_end_date"</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"exposures"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="outcome-cohorts">Outcome cohorts<a class="anchor" aria-label="anchor" href="#outcome-cohorts"></a>
</h3>
<p>Similarly, we can define the outcome cohorts for our analyses. For
that, we will use the 40 most frequent conditions in the database. To
identify the most frequent conditions we can run:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">sql_query</span> <span class="op">&lt;-</span> <span class="st">"</span></span>
<span><span class="st">  SELECT co.condition_concept_id, c.concept_name,</span></span>
<span><span class="st">    COUNT(DISTINCT condition_occurrence_id) n</span></span>
<span><span class="st">  FROM condition_occurrence co</span></span>
<span><span class="st">  JOIN concept c ON co.condition_concept_id = c.concept_id</span></span>
<span><span class="st">  GROUP BY co.condition_concept_id, c.concept_name</span></span>
<span><span class="st">  ORDER BY n DESC</span></span>
<span><span class="st">  LIMIT 40;</span></span>
<span><span class="st">"</span></span>
<span></span>
<span><span class="va">outcomes</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">connection</span>, <span class="va">sql_query</span><span class="op">)</span></span></code></pre></div>
<p>Then, we can extract the concept cohorts with:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">conceptListOutcomes</span> <span class="op">&lt;-</span> <span class="va">outcomes</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"outcome"</span>, <span class="va">condition_concept_id</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span>,</span>
<span>    value <span class="op">=</span> <span class="va">condition_concept_id</span></span>
<span><span class="op">)</span>  <span class="op">|&gt;</span></span>
<span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/enframe.html" class="external-link">deframe</a></span><span class="op">(</span><span class="op">)</span>  <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span><span class="va">cdm</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">CohortConstructor</span><span class="fu">::</span><span class="fu">conceptCohort</span><span class="op">(</span></span>
<span>    conceptSet <span class="op">=</span> <span class="va">conceptListOutcomes</span>,</span>
<span>    exit <span class="op">=</span> <span class="st">"event_start_date"</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"outcomes"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>After successfully running the previous code snippets, we should have
created two new tables in the demo database named
<code>demo_exposures</code> and <code>demo_outcomes</code>.</p>
<p>Finally, it’s best practice to make sure that we disconnect from the
database:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html" class="external-link">dbDisconnect</a></span><span class="op">(</span><span class="va">connection</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="running-a-simulation">Running a simulation<a class="anchor" aria-label="anchor" href="#running-a-simulation"></a>
</h2>
<div class="section level3">
<h3 id="outcome-models">Outcome models<a class="anchor" aria-label="anchor" href="#outcome-models"></a>
</h3>
<p>Now, we can proceed with setting up the simulation study. The first
step is to train the outcome models that will be later used to generate
outcome times for every patient. To do that, we first need to decide
whether the entire database or only the exposure cohorts will be used
for fitting the models. In this case, the entire database will be used.
We will need to generate a new cohort table where the target cohort for
the prediction model will be stored. We can do that by running the
following code:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="../reference/generateModelCohort.html">generateModelCohort</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cdmDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  resultDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  resultTable <span class="op">=</span> <span class="st">"model_cohort"</span>,</span>
<span>  washoutPeriod <span class="op">=</span> <span class="fl">365</span>,</span>
<span>  maxObservationPeriod <span class="op">=</span> <span class="fl">15</span> <span class="op">*</span> <span class="fl">365.25</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Since the entire database is used, the code above makes sure that for
every patient the time at risk starts 1 year after their observation
period start date and their time at risk is limited at 15 years.</p>
<p>Then, the outcome models can be fitted using the following code.
First, a set of possible features to be included in the models needs to
be defined using function <code>createCovariateSettings</code>. Function
<code>trainPoissonModels</code> actually trains the models using Poisson
regression with LASSO regularization. The function can be parallelized
using package <a href="https://cran.r-project.org/web/packages/mirai/index.html" class="external-link">mirai</a>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">covariateSettings</span> <span class="op">&lt;-</span> <span class="fu">FeatureExtraction</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FeatureExtraction/man/createCovariateSettings.html" class="external-link">createCovariateSettings</a></span><span class="op">(</span></span>
<span>  useDemographicsGender <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  useDemographicsAgeGroup <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  useConditionOccurrenceAnyTimePrior <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  useMeasurementAnyTimePrior <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">mirai</span><span class="fu">::</span><span class="fu"><a href="https://mirai.r-lib.org/reference/daemons.html" class="external-link">daemons</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/trainPoissonModels.html">trainPoissonModels</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cdmDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  exposureDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  exposureTable <span class="op">=</span> <span class="st">"model_cohort"</span>,</span>
<span>  outcomeDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  outcomeTable <span class="op">=</span> <span class="st">"drugon_exposures"</span>,</span>
<span>  outcomeIds <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">40</span>,</span>
<span>  covariateSettings <span class="op">=</span> <span class="va">covariateSettings</span>,</span>
<span>  saveDir <span class="op">=</span> <span class="st">"models"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">mirai</span><span class="fu">::</span><span class="fu"><a href="https://mirai.r-lib.org/reference/daemons.html" class="external-link">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="cohort-extraction">Cohort extraction<a class="anchor" aria-label="anchor" href="#cohort-extraction"></a>
</h3>
<p>Now that we have the outcome models generated for all the outcomes of
interest an intermediate step of limiting the database to the
user-defined cohorts needs to be executed. The purpose of this step is
to generate a stand-alone OMOP database stored locally that can be
queried possibly thousands of times over the execution of the simulation
study. This limited database can be created using the code below:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="../reference/extractCohorts.html">extractCohorts</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  exposureTable <span class="op">=</span> <span class="st">"drugon_exposures"</span>,</span>
<span>  exposureIds <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>,</span>
<span>  cohortTable <span class="op">=</span> <span class="st">"combined_target"</span>,</span>
<span>  resultDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  exposureDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  cdmDatabaseSchema <span class="op">=</span> <span class="st">"main"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Alexandros Rekkas.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
